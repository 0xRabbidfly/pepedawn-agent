# PEPEDAWN Bot Flow Diagrams ğŸ¸

> **Visual teaching guide for understanding how PEPEDAWN works**  
> Each diagram shows the complete flow from user input to bot response

---

## ğŸ“‹ Table of Contents

1. [Card Viewing Flow (`/f`)](#1-card-viewing-flow-f)
2. [Card Visual Analysis Flow (`/fv`)](#2-card-visual-analysis-flow-fv)
3. [Fake Appeal Test Flow (`/ft`)](#3-fake-appeal-test-flow-ft)
4. [Lore Retrieval Flow (`/fl`)](#4-lore-retrieval-flow-fl)
5. [Memory Capture Flow ("remember this")](#5-memory-capture-flow-remember-this)
6. [General Conversation Flow](#6-general-conversation-flow)

---

## 1. Card Viewing Flow (`/f`)

**Command:** `/f CARDNAME` or `/f ARTIST` or `/f` (random)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER INPUT                               â”‚
â”‚  /f FREEDOMKEK  â”‚  /f Rare Scrilla  â”‚  /f  â”‚  /f FREEDOMK      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  1. PARSE COMMAND     â”‚
                â”‚  - Extract asset name â”‚
                â”‚  - Detect random req  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  Is Random Request?   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”œâ”€â”€â”€ YES â”€â”€â”€â”¤â”€â”€â”€ NO â”€â”€â”
                â”‚                     â”‚
                â–¼                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Pick Random Card   â”‚   â”‚ 2. EXACT CARD MATCH  â”‚
    â”‚ from 890+ cards    â”‚   â”‚ Lookup in index      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                          â”‚
              â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                  â”‚ Card Found?    â”‚
              â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                          â”‚
              â”‚                  YES â”€â”€â”€â”€â”¼â”€â”€â”€â”€ NO
              â”‚                   â”‚              â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚ 3. EXACT ARTIST      â”‚
                                      â”‚ Match by artist name â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚ Artist Found?  â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                         YES â”€â”€â”€â”€â”¼â”€â”€â”€â”€ NO
                                          â”‚              â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â–¼
                        â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                    â”‚ 4a. FUZZY CARD MATCH   â”‚
                        â”‚                    â”‚ Levenshtein distance   â”‚
                        â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                                 â”‚
                        â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                     â”‚ Similarity Score?    â”‚
                        â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                                 â”‚
                        â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚            â”‚                    â”‚               â”‚
                        â”‚         â‰¥75%                55-74%           <55%
                        â”‚            â”‚                    â”‚               â”‚
                        â”‚            â–¼                    â–¼               â–¼
                        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   â”‚ Auto-correct â”‚    â”‚ Show top 3  â”‚  â”‚ Try fuzzy    â”‚
                        â”‚   â”‚ & show card  â”‚    â”‚ suggestions â”‚  â”‚ artist match â”‚
                        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                                                â”‚
                        â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                        â”‚                                        â”‚ Artist match?â”‚
                        â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                                                â”‚
                        â”‚                                         YES â”€â”€â”€â”¼â”€â”€â”€ NO
                        â”‚                                         â”‚           â”‚
                        â–¼                                         â–¼           â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 5. BUILD CARD MESSAGE    â”‚               â”‚ Random by   â”‚  â”‚ Error msg  â”‚
          â”‚ - Artist info            â”‚               â”‚ artist      â”‚  â”‚ with tips  â”‚
          â”‚ - Supply, issuance       â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ - Series info            â”‚
          â”‚ - Artist profile button  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 6. SEND WITH MEDIA       â”‚
          â”‚ - Attach image/video/GIF â”‚
          â”‚ - Clean preview display  â”‚
          â”‚ - No broken URLs shown   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚    USER SEES CARD! âœ¨    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features:**
- **4-tier matching:** Exact card â†’ Exact artist â†’ Fuzzy card â†’ Fuzzy artist
- **Auto-correction:** â‰¥75% similarity shows card immediately
- **Suggestions:** 55-74% shows top 3 matches
- **Inline buttons:** `/f`, `/c`, `/p` suggestions come with tap-to-fill buttons for instant retry
- **890+ cards** in-memory index
- **<200ms** response time for known cards

> **Note:** The Fake Commons (`/c`) and Rare Pepes (`/p`) actions reuse this same pipeline, so the auto-correct and suggestion behaviour is consistent across all card collections.

---

## 2. Card Visual Analysis Flow (`/fv`)

**Command:** `/fv CARDNAME`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER INPUT                               â”‚
â”‚                    /fv FREEDOMKEK                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  1. PARSE COMMAND     â”‚
                â”‚  Extract card name    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  2. LOOKUP CARD       â”‚
                â”‚  Search in index      â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Card found?   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    NO â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€ YES
                     â”‚              â”‚
                     â–¼              â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Error:       â”‚  â”‚ 3. DETERMINE IMAGE URL   â”‚
            â”‚ Card not     â”‚  â”‚ - Use override if exists â”‚
            â”‚ found        â”‚  â”‚ - Use S3 URL otherwise   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ - Handle MP4 â†’ static    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ 4. VISION API CALL       â”‚
                              â”‚ Model: GPT-4o (or config)â”‚
                              â”‚                          â”‚
                              â”‚ Analyze:                 â”‚
                              â”‚ â€¢ Extract ALL text (OCR) â”‚
                              â”‚ â€¢ Visual composition     â”‚
                              â”‚ â€¢ Color palette          â”‚
                              â”‚ â€¢ Artistic style         â”‚
                              â”‚ â€¢ Meme references        â”‚
                              â”‚ â€¢ Crypto culture refs    â”‚
                              â”‚ â€¢ Vibe check             â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ 5. FORMAT RESPONSE       â”‚
                              â”‚                          â”‚
                              â”‚ ğŸ“ TEXT EXTRACTION       â”‚
                              â”‚ ğŸ¨ VISUAL BREAKDOWN      â”‚
                              â”‚ ğŸ§¬ MEMETIC DNA           â”‚
                              â”‚ ğŸ¯ VIBE CHECK            â”‚
                              â”‚                          â”‚
                              â”‚ + Card metadata          â”‚
                              â”‚ + Cost: ~$0.005          â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  USER SEES ANALYSIS! ğŸ”  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features:**
- **OCR text extraction** - Reads ALL visible text
- **Memetic commentary** - Identifies meme references
- **Visual analysis** - Composition, colors, style
- **Cost tracking** - ~$0.005 per analysis (GPT-4o)
- **MP4 handling** - Uses static frame for animations

---

## 3. Fake Appeal Test Flow (`/ft`)

**Command:** `/ft` + attach image

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER INPUT                               â”‚
â”‚              /ft + [uploaded image]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  1. VALIDATE INPUT    â”‚
                â”‚  - Check attachment   â”‚
                â”‚  - Block animations   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Has image?    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    NO â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€ YES
                     â”‚              â”‚
                     â–¼              â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Error:       â”‚  â”‚  Is animation?           â”‚
            â”‚ No image     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                                  YES â”€â”€â”€â”¼â”€â”€â”€ NO
                                   â”‚          â”‚
                                   â–¼          â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ Block & ask  â”‚  â”‚ 2. VALIDATE IMAGE   â”‚
                          â”‚ to clip frameâ”‚  â”‚ Check accessibility â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚ 3. DUPLICATE DETECTION    â”‚
                                          â”‚ (if REPLICATE_API_TOKEN)  â”‚
                                          â”‚                           â”‚
                                          â”‚ - Generate CLIP embedding â”‚
                                          â”‚ - Compare to 890+ cards   â”‚
                                          â”‚ - Calculate similarity    â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚  Similarity Score?       â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                       â”‚                    â”‚
                           â‰¥95%                    â‰¥85%               30-84%
                              â”‚                       â”‚                    â”‚
                              â–¼                       â–¼                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ EXACT MATCH! ğŸš¨   â”‚  â”‚ HIGH SIMILARITY  â”‚  â”‚ LOW MATCH    â”‚
                    â”‚ "HA! NICE TRY!"   â”‚  â”‚ "SNEAKY!"        â”‚  â”‚ Show closest â”‚
                    â”‚ 10/10 auto-score  â”‚  â”‚ Modified/clipped â”‚  â”‚ + continue   â”‚
                    â”‚ Skip analysis     â”‚  â”‚ Skip analysis    â”‚  â”‚ to analysis  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                         â”‚
                                                                         â–¼
                                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                              â”‚ 4. VISION ANALYSIS â”‚
                                                              â”‚ Model: GPT-4o      â”‚
                                                              â”‚                    â”‚
                                                              â”‚ Score based on:    â”‚
                                                              â”‚ 1. PEPE culture â­ï¸ â”‚
                                                              â”‚ 2. Text content â­ï¸ â”‚
                                                              â”‚ 3. Green palette âš¡ â”‚
                                                              â”‚ 4. Pepe name/refs âš¡â”‚
                                                              â”‚                    â”‚
                                                              â”‚ Format:            â”‚
                                                              â”‚ ğŸ“ TEXT           â”‚
                                                              â”‚ ğŸ¨ VISUAL         â”‚
                                                              â”‚ ğŸ§¬ MEMETIC DNA    â”‚
                                                              â”‚ ğŸ¯ FAKE APPEAL /10â”‚
                                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                        â”‚
                                                                        â–¼
                                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                              â”‚ 5. SEND RESULT     â”‚
                                                              â”‚ - Show similarity  â”‚
                                                              â”‚   if detected      â”‚
                                                              â”‚ - Full analysis    â”‚
                                                              â”‚ - Appeal score     â”‚
                                                              â”‚                    â”‚
                                                              â”‚ Cost: ~$0.005      â”‚
                                                              â”‚ + $0.0002 (CLIP)   â”‚
                                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                        â”‚
                                                                        â–¼
                                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                              â”‚  USER SEES SCORE!  â”‚
                                                              â”‚        ğŸ¯          â”‚
                                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features:**
- **Duplicate detection** - CLIP embeddings (optional)
- **Strict scoring** - Based on Fake Rares ethos
- **Animation blocking** - Requires static frame
- **Cost optimization** - Early exit on exact match
- **4-tier weighting:** PEPE culture > Text > Green > Name

---

## 4. Lore Retrieval Flow (`/fl`)

**Command:** `/fl TOPIC` or `/fl` (random)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER INPUT                               â”‚
â”‚  /fl Rare Scrilla  â”‚  /fl FREEDOMKEK  â”‚  /fl purple era  â”‚ /fl â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  1. QUERY EXPANSION   â”‚
                â”‚  Add synonyms/aliases â”‚
                â”‚  "faka" â†’ "La Faka    â”‚
                â”‚           Nostra"     â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  2. VECTOR SEARCH (GLOBAL)            â”‚
                â”‚  Search across ALL sources:           â”‚
                â”‚  â€¢ Telegram chat archives (tg)        â”‚
                â”‚  â€¢ pepe.wtf wiki pages (wiki)         â”‚
                â”‚  â€¢ User memories (mem) â­              â”‚
                â”‚                                       â”‚
                â”‚  - Retrieve 24 passages               â”‚
                â”‚  - Automatic fallback expansion       â”‚
                â”‚  - Timeout: 10s                       â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  3. SOURCE-BASED RANKING              â”‚
                â”‚  Priority boost:                      â”‚
                â”‚  â€¢ Memories: 4.0x (highest) â­â­â­     â”‚
                â”‚  â€¢ Wiki: 2.0x (authoritative) â­â­    â”‚
                â”‚  â€¢ Telegram: 0.5x (noise) âš¡          â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  4. QUERY CLASSIFICATION              â”‚
                â”‚  Keyword scoring + conversational     â”‚
                â”‚  detection                            â”‚
                â”‚  â€¢ FACTS: Rules, specs, how-to        â”‚
                â”‚  â€¢ LORE: Stories, history, vibes      â”‚
                â”‚  â€¢ UNCERTAIN: Ambiguous/casual        â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Query Type?        â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚           â”‚            â”‚
             FACTS       LORE      UNCERTAIN
                â”‚           â”‚            â”‚
                â–¼           â–¼            â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚Send clarificationâ”‚
                                â”‚"ğŸ¤” Not sure..." â”‚
                                â”‚Try examples     â”‚
                                â”‚Or ask w/o /fl   â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                       (done)
                
                â”‚           â”‚
                â–¼           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 5a. FACTS SELECTION â”‚   â”‚ 5b. MMR DIVERSITY      â”‚
    â”‚ â€¢ LRU filter fresh  â”‚   â”‚ â€¢ Filter recently used â”‚
    â”‚ â€¢ Take top-k by     â”‚   â”‚ â€¢ Apply MMR algorithm  â”‚
    â”‚   RELEVANCE only    â”‚   â”‚ â€¢ Select 4-6 diverse   â”‚
    â”‚ â€¢ NO diversity MMR  â”‚   â”‚ â€¢ Balance relevance    â”‚
    â”‚   (want best facts) â”‚   â”‚   vs diversity         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                         â”‚
               â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 6a. FACTS MODE      â”‚   â”‚ 6b. LORE MODE          â”‚
    â”‚                     â”‚   â”‚                        â”‚
    â”‚ â€¢ Filter wiki+mem   â”‚   â”‚ â€¢ Cluster passages     â”‚
    â”‚ â€¢ Take top 5        â”‚   â”‚ â€¢ Generate summaries   â”‚
    â”‚ â€¢ Direct to LLM     â”‚   â”‚ â€¢ Group similar topics â”‚
    â”‚ â€¢ NO clustering     â”‚   â”‚ â€¢ Create 2-4 clusters  â”‚
    â”‚                     â”‚   â”‚                        â”‚
    â”‚ Prompt style:       â”‚   â”‚ Prompt style:          â”‚
    â”‚ - Factual           â”‚   â”‚ - "I remember when..." â”‚
    â”‚ - Lists/bullets     â”‚   â”‚ - Historian/witness    â”‚
    â”‚ - Specifications    â”‚   â”‚ - Community moments    â”‚
    â”‚ - Rules/steps       â”‚   â”‚ - Quote actual people  â”‚
    â”‚ - NO storytelling   â”‚   â”‚ - Show reactions       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                         â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ 7. LLM STORY COMPOSER  â”‚
                â”‚ Model: gpt-5/gpt-4o    â”‚
                â”‚ (LORE_STORY_MODEL)     â”‚
                â”‚                        â”‚
                â”‚ Generate:              â”‚
                â”‚ â€¢ 80-120 words         â”‚
                â”‚ â€¢ Concise but complete â”‚
                â”‚ â€¢ Natural tone         â”‚
                â”‚ â€¢ Include context      â”‚
                â”‚                        â”‚
                â”‚ Cost: ~$0.01-0.02      â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ 8. ADD SOURCE CITATIONSâ”‚
                â”‚ Format:                â”‚
                â”‚ tg:1234 || wiki:page || â”‚
                â”‚ mem:abc123 by:User     â”‚
                â”‚                        â”‚
                â”‚ (hidden if env flag)   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  9. SEND LORE! ğŸ“š      â”‚
                â”‚  Latency: 1-3s         â”‚
                â”‚  Mark passages as used â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features:**
- **3 source types:** Telegram archives, wiki, user memories
- **Hybrid search:** Exact card match + vector search for card memories
- **Query classification:** FACTS vs LORE vs UNCERTAIN (conversational detection)
- **UNCERTAIN handling:** Sends clarification prompt with examples, routes casual chat to AI
- **Conditional MMR:** Diversity for LORE, relevance-only for FACTS âœ… **FIXED** (Nov 2025 - was incorrectly applying MMR to all queries)
- **Card memory emphasis:** Dedicated cluster (12â†’5 passages), no summarization (preserves artist words)
- **LRU cache:** Don't repeat recently shown content
- **Card discovery variety:** When multiple cards match, picks a *fresh* candidate (30â€¯min LRU) and randomly rotates through the top 3 to avoid the same answer every time (Nov 2025)
- **Source priority:** Memories (4.0x) > Wiki (2.0x) > Telegram (0.5x)
- **Global search:** Searches across ALL chats/content

> ğŸ†• **Card Discovery Randomization (Nov 2025)**
>
> - Top matches are grouped by asset and scored.
> - The bot prefers cards you havenâ€™t seen in the last 30 minutes (per room).
> - If several fresh matches remain, it chooses one at random before formatting the story.
> - Fallback still returns the strongest match when only a single candidate exists.

---

## 5. Memory Capture Flow ("/fr" or "remember this")

**Command:** `/fr CARDNAME <lore>`, `/fr <general lore>`, `CARDNAME remember this: FACT`, or reply to bot with "remember this"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER INPUT                               â”‚
â”‚ "/fr FREEDOMKEK it was inspired by Free Kekistan"               â”‚
â”‚              OR                                                 â”‚
â”‚ "FREEDOMKEK remember this: it was inspired by Free Kekistan"    â”‚
â”‚              OR                                                 â”‚
â”‚ [Reply to bot message] "remember this"                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  1. DETECTION         â”‚
                â”‚  Plugin event:        â”‚
                â”‚  MESSAGE_RECEIVED     â”‚
                â”‚                       â”‚
                â”‚  Check:               â”‚
                â”‚  â€¢ /fr command OR     â”‚
                â”‚  â€¢ Has CAPITALIZED    â”‚
                â”‚    word OR            â”‚
                â”‚  â€¢ Is reply to bot OR â”‚
                â”‚  â€¢ Has bot mention    â”‚
                â”‚  AND                  â”‚
                â”‚  â€¢ Contains "remember â”‚
                â”‚    this"              â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Detected?     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    NO â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€ YES
                     â”‚              â”‚
                (ignore)            â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ 2. EXTRACT CONTENT       â”‚
                              â”‚                          â”‚
                              â”‚ If direct command:       â”‚
                              â”‚ â€¢ Remove "remember this:"â”‚
                              â”‚ â€¢ Extract fact text      â”‚
                              â”‚                          â”‚
                              â”‚ If reply to bot:         â”‚
                              â”‚ â€¢ Get original bot msg   â”‚
                              â”‚ â€¢ Combine with user's    â”‚
                              â”‚   comment                â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ 3. VALIDATE CONTENT      â”‚
                              â”‚                          â”‚
                              â”‚ Check:                   â”‚
                              â”‚ â€¢ Not empty              â”‚
                              â”‚ â€¢ Not too long           â”‚
                              â”‚ â€¢ Valid format           â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚  Valid?        â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                 NO â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€ YES
                                  â”‚              â”‚
                             (ignore)            â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚ 4. BUILD METADATA      â”‚
                                      â”‚                        â”‚
                                      â”‚ Collect:               â”‚
                                      â”‚ â€¢ userId               â”‚
                                      â”‚ â€¢ displayName          â”‚
                                      â”‚ â€¢ timestamp            â”‚
                                      â”‚ â€¢ roomId               â”‚
                                      â”‚                        â”‚
                                      â”‚ IMPORTANT:             â”‚
                                      â”‚ Embed metadata in text â”‚
                                      â”‚ (KnowledgeService      â”‚
                                      â”‚  strips custom fields) â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚ 5. STORE IN KNOWLEDGE  â”‚
                                      â”‚                        â”‚
                                      â”‚ Format:                â”‚
                                      â”‚ [MEMORY:userId:        â”‚
                                      â”‚  displayName:timestamp]â”‚
                                      â”‚ actual_content         â”‚
                                      â”‚                        â”‚
                                      â”‚ Stored in:             â”‚
                                      â”‚ Knowledge DB (global)  â”‚
                                      â”‚                        â”‚
                                      â”‚ Searchable via /fl!    â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚ 6. CONFIRM TO USER     â”‚
                                      â”‚                        â”‚
                                      â”‚ "storing the memory... â”‚
                                      â”‚  to access this in the â”‚
                                      â”‚  future ensure you use â”‚
                                      â”‚  the /fl fake lore     â”‚
                                      â”‚  method"               â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚   MEMORY STORED! âœ…    â”‚
                                      â”‚                        â”‚
                                      â”‚ Now searchable via:    â”‚
                                      â”‚ /fl [related query]    â”‚
                                      â”‚                        â”‚
                                      â”‚ Priority: HIGHEST (4x) â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features:**
- **2 input methods:** Direct command or reply to bot
- **Card detection:** Validates card names, adds [CARD:NAME] marker for exact retrieval
- **Metadata embedding:** Workaround for KnowledgeService limitation
- **Global storage:** Available to all chats
- **Highest priority:** 4x boost in lore searches
- **Dedicated clustering:** Card memories preserved raw (no summarization) in LORE mode
- **User attribution:** Shows who contributed the memory
- **Automatic validation:** Filters empty/invalid content

---

## 6. General Conversation Flow

**When:** Any message that doesn't match a command

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER INPUT (non-command)                    â”‚
â”‚  "Tell me about Fake Rares"  â”‚  "What card fits COIT?"             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. PRE-GUARDS (Plugin)       â”‚
â”‚    â€¢ Slash command / memory? â”‚
â”‚    â€¢ FAKEASF + off-topic     â”‚
â”‚    â€¢ Engagement gate         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
          Short-circuit
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SMART ROUTER ENTRY        â”‚
â”‚    Gather last 20 posts      â”‚
â”‚    Sanitize + clamp context  â”‚
â”‚    Bundle transcript + msg   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. INTENT CLASSIFIER (LLM)   â”‚
â”‚    Outputs: intent + command â”‚
â”‚    INTENT âˆˆ {FACTS, LORE,    â”‚
â”‚      CHAT, CARD_FASTPATH,    â”‚
â”‚      CARD_RECOMMEND,         â”‚
â”‚      CMDROUTE, NORESPONSE}   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                                                             â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚CARD_FASTPATHâ”‚                                             â”‚  Other intents   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ fast intent score â‰¥ threshold                                â”‚
      â”‚                                                              â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Deterministic Card Planâ”‚                    â”‚ 4. MODE PRESET + RETRIEVAL               â”‚
â”‚preferCardFacts=true   â”‚                    â”‚    Map intent â†’ source weights/topK      â”‚
â”‚â†’ call `/f CARD`       â”‚                    â”‚    Call KnowledgeOrchestratorService     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚    (FACTS skip MMR, LORE clusters, etc.) â”‚
      â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â””â”€â”€â–º Send card + one-liner âœ Done                  â”‚
                                                        â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚ 5. MODE EXECUTION                                  â”‚
                                 â”‚  â€¢ FACTS â†’ factual answer + citations              â”‚
                                 â”‚  â€¢ LORE  â†’ historian story + citations             â”‚
                                 â”‚  â€¢ CHAT  â†’ small-model social reply                â”‚
                                 â”‚  â€¢ CARD_RECOMMEND â†’ multi-card plan                â”‚
                                 â”‚  â€¢ CMDROUTE â†’ run suggested /command               â”‚
                                 â”‚  â€¢ NORESPONSE â†’ suppression token (emoji optional) â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚ 6. TELEMETRY & OUTPUT              â”‚
                                 â”‚  â€¢ SmartRouterDecisionLog (intent, â”‚
                                 â”‚    reason, fast-path metrics)      â”‚
                                 â”‚  â€¢ TelemetryService.logConversationâ”‚
                                 â”‚  â€¢ runtime.useModel token tracking â”‚
                                 â”‚  â€¢ Send Telegram-safe response     â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features (Smart Router era):**
- **Layered guards before routing** â€“ commands, FAKEASF/off-topic policies, and engagement scoring run before Smart Router does any work.
- **Context-aware classifier** â€“ every decision uses a sanitized 20-message transcript plus the live message so multi-user context and bot replies are visible to the LLM.
- **Deterministic card fast-path** â€“ strong card discovery intent short-circuits directly into `/f <card>` with `preferCardFacts=true`, skipping the full LLM plan.
- **Mode presets + KnowledgeOrchestrator** â€“ each intent has fixed source weights/topK so FACTS, LORE, CHAT, and CARD_RECOMMEND share the same retrieval pipeline with different knobs.
- **Chat + command routing** â€“ CHAT responses use the lightweight persona model, CMDROUTE invokes the mapped slash flow, and NORESPONSE emits a suppression token.
- **Unified telemetry** â€“ every plan logs a SmartRouterDecisionLog entry and TelemetryService call, with token/cost tracking via the runtime `useModel` monkey patch.

---

## ğŸ¯ Flow Summary

| Flow | Trigger | Core Tech | Output | Cost |
|------|---------|-----------|---------|------|
| **Card Viewing** | `/f CARD` | 4-tier matching, fuzzy search | Card image/video + metadata | Free |
| **Visual Analysis** | `/fv CARD` | GPT-4o Vision, OCR | Memetic analysis breakdown | ~$0.005 |
| **Fake Appeal Test** | `/ft` + image | CLIP embeddings, GPT-4o | Appeal score + duplicate check | ~$0.007 |
| **Lore Retrieval** | `/fl TOPIC` | RAG (vector search), clustering, LLM | Historical recounting | ~$0.01 |
| **Memory Capture** | "/fr" or "remember this" | Knowledge DB storage | Confirmation message | Free |
| **Conversation** | Any text | ElizaOS + GPT-4 | Natural AI response | ~$0.01 |

---

## ğŸŒ Unified Response Map (NEW)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          USER INPUT / EVENTS                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Slash Commands                â”‚ Natural Language                            â”‚
â”‚ (/f, /fl, /fv, /ft, /fr, ...) â”‚ (DMs, group chat, replies)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                                        â”‚
              â”‚                                        â–¼
              â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                             â”‚  Message Classifier        â”‚
              â”‚                             â”‚  (FACTS / LORE / UNCERTAIN â”‚
              â”‚                             â”‚   + command detection)     â”‚
              â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                                         â”‚
              â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                             â”‚                       â”‚
              â”‚                             â–¼                       â–¼
              â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                 â”‚  Knowledge Orchestratorâ”‚ â”‚  Bootstrap Conversationâ”‚
              â”‚                 â”‚  (FACTS / LORE Modes)â”‚ â”‚  (PEPEDAWN persona)   â”‚
              â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                         â”‚                          â”‚
              â”‚            uses vector DB + LLM         uses LLM + context providers
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ACTION-SPECIFIC FLOWS                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Card Viewers (/f,/c,/p)       â”‚ Market Pulse (/fm)       â”‚ Vision (/fv,/ft) â”‚
â”‚ â€¢ Card index + media map      â”‚ â€¢ PGlite transactions    â”‚ â€¢ Card index +   â”‚
â”‚ â€¢ No LLM                      â”‚ â€¢ TokenScan API          â”‚   GPT-4o Vision  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Memory Capture (/fr, natural) â”‚ Help/Utility (/help,/fc) â”‚ Telemetry/Other â”‚
â”‚ â€¢ Writes to knowledge DB      â”‚ â€¢ Static templates       â”‚ â€¢ JSONL logs     â”‚
â”‚ â€¢ No LLM                      â”‚ â€¢ No LLM                 â”‚ â€¢ No user output â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LEGEND:
  ğŸ”· Local DB only (no LLM): card viewers, market, memory capture, telemetry.
  ğŸŸ£ Hybrid (Local DB + LLM): lore FACTS/LORE modes, conversation, vision, educate flows.
  ğŸ”¸ External API touchpoints: TokenScan (market, notifications), Replicate (optional CLIP).
```

**Highlights**
- **Classifier hub** routes natural messages into FACTS (concise answers), LORE (storytelling with random card rotation), or UNCERTAIN (Bootstrap chat).
- **Hybrid flows** leverage both local stores (vector DB, history providers) and LLMs via `modelGateway`.
- **Pure local flows** (card viewers, market, memory capture, telemetry) never touch the LLM budget.

> Use this map to spot optimization targets: e.g., FACTS mode already rides the cheapest model; market flow is purely local and sensitive to PGlite performance; conversation depends entirely on Bootstrap token costs.

---

## ğŸ“Š Performance Metrics

- **Card lookup:** <200ms (known cards), 2-10s (unknown)
- **Visual analysis:** 1-3s (vision API call)
- **Lore retrieval:** 1-3s (vector search + LLM)
- **Memory capture:** <500ms (async storage)
- **Conversation:** 1-2s (LLM response)

---

## ğŸ’° Cost Breakdown (per 100 messages/day)

- **Card Display:** Free (no AI)
- **Visual Analysis (20/day):** $3/month
- **Lore Generation (30/day):** $4/month
- **Conversations (50/day):** $1-2/month
- **Total:** ~$8-10/month (for active usage)

---

## ğŸ”— Data Sources

### Knowledge Base (for `/fl`)
1. **Telegram Archives** - Historical community chat exports
2. **pepe.wtf Wiki** - Official documentation and lore
3. **User Memories** - Community-contributed facts (via "remember this")

### Card Database
- **890+ cards** from `fake-rares-data.json`
- **Auto-refresh** from GitHub every hour
- **Sources:** pepe.wtf + fakeraredirectory.com

---

## ğŸ› ï¸ Tech Stack Summary

| Component | Technology |
|-----------|-----------|
| **Framework** | ElizaOS (AI agent framework) |
| **Runtime** | Bun (JavaScript/TypeScript) |
| **Bot API** | Telegraf (Telegram) |
| **AI Models** | GPT-4o, GPT-4o-mini, GPT-5 (configurable) |
| **Vision** | GPT-4o Vision API |
| **Embeddings** | OpenAI text-embedding-3-small, CLIP (Replicate) |
| **Vector DB** | PGlite (embedded PostgreSQL) |
| **Knowledge** | @elizaos/plugin-knowledge |
| **Character** | pepedawn.ts (persona definition) |

---

## ğŸ“ Quick Onboarding Checklist

For new team members, ensure you understand:

- âœ… **Flow 1 (Card Viewing)** - Core feature, most used
- âœ… **Flow 4 (Lore Retrieval)** - Most complex, RAG pipeline
- âœ… **Flow 5 (Memory Capture)** - Community-driven knowledge
- âœ… **Flow 6 (Conversation)** - Fallback/default behavior
- âš¡ **Flow 2-3 (Visual)** - Optional premium features

---

**Last Updated:** October 29, 2025  
**Version:** 2.2.0  
**Status:** Ready for onboarding ğŸ“

